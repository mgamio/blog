<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Implementing hot-warm architecture in Elasticsearch for time-series data | codersite</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Implementing hot-warm architecture in Elasticsearch for time-series data" />
<meta name="author" content="moises" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hot-warm architecture for log analytics with Elasticsearch." />
<meta property="og:description" content="Hot-warm architecture for log analytics with Elasticsearch." />
<link rel="canonical" href="http://localhost:4000/hot-warm-architecture-elasticsearch/" />
<meta property="og:url" content="http://localhost:4000/hot-warm-architecture-elasticsearch/" />
<meta property="og:site_name" content="codersite" />
<meta property="og:image" content="http://localhost:4000/assets/images/elastic.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-26T00:00:00+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/elastic.jpg" />
<meta property="twitter:title" content="Implementing hot-warm architecture in Elasticsearch for time-series data" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"moises"},"dateModified":"2021-02-26T00:00:00+01:00","datePublished":"2021-02-26T00:00:00+01:00","description":"Hot-warm architecture for log analytics with Elasticsearch.","headline":"Implementing hot-warm architecture in Elasticsearch for time-series data","image":"http://localhost:4000/assets/images/elastic.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/hot-warm-architecture-elasticsearch/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.svg"},"name":"moises"},"url":"http://localhost:4000/hot-warm-architecture-elasticsearch/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<script src="/assets/js/jquery.min.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042"
  crossorigin="anonymous"></script></head>


<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
	<a class="navbar-brand" href="/">
    <img src="/assets/images/logo.svg" height="30" alt="codersite">
    </a>
    <!-- End Logo -->
	 
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>
 
                <li class="nav-item">
                <a class="nav-link" href="/recommended.html">Recommended</a>
                </li>
				
                <li class="nav-item">
                <a class="nav-link" href="/book">Books</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->
<div class="site-content">

<div class="container">

<!-- Site Title
================================================== --><!-- nothing --><!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=Implementing hot-warm architecture in Elasticsearch for time-series data&url=http://localhost:4000/hot-warm-architecture-elasticsearch/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/hot-warm-architecture-elasticsearch/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

         <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/hot-warm-architecture-elasticsearch/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>	
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/author.jpg" alt="Moises Gamio">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://codersite.dev">Moises Gamio</a>
						
						<a target="_blank" href="https://twitter.com/MoisesGamio" class="btn follow">Follow</a>
                        <span class="author-description">Software Engineer. Comprehensive experience in all phases of the software development lifecycle for several economic sectors.</span>
						
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">Implementing hot-warm architecture in Elasticsearch for time-series data</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
			
			
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid" src="/assets/images/elastic.jpg" alt="Implementing hot-warm architecture in Elasticsearch for time-series data">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p>Elasticsearch is a distributed real-time document store where every field is indexed and searchable. It provides near real-time search and analysis for all types of data.</p>

<p>Elasticsearch is document oriented, meaning that it stores entire objects or documents.</p>

<h2 id="fundamentals-concepts">Fundamentals concepts</h2>

<p>The act of storing data in Elasticsearch is called <em>indexing</em>.</p>

<p>An <strong>index</strong> is a collection of documents and each document is a collection of fields, which are the key-value pairs that contain your data. Every index has some properties like mappings, settings, and aliases.</p>

<p>In Elasticsearch, a document belongs to a type, and those types live inside an index. We can draw a parallel to a traditional relational database:</p>

<p>Relational DB ⇒ Databases ⇒ Tables ⇒ Rows ⇒ Columns</p>

<p>Elasticsearch ⇒ Indices ⇒ Types ⇒ Documents ⇒ Fields</p>

<p>In Elasticsearch, the term document has a specific meaning. It refers to the top-level, or root object that is serialized into JSON and stored in Elasticsearch under a unique ID.</p>

<p>Elasticsearch lets you insert documents without a predefined schema (in RDBMS you need to define tables in advance).</p>

<p><strong>Inverted index</strong></p>

<p>Relational databases add an index, such as a B-tree index, to specific columns in order to improve the speed of data retrieval. Elasticsearch use a structure called an inverted index for exactly the same purpose.</p>

<p>By default, every field in a document is indexed (has an inverted index) and thus is searchable – FullText search. A field without an inverted index is not searchable.</p>

<p>An inverted index consists of a list of all the unique words that appear in any document, and for each word, a list of the documents in which it appears</p>

<p>For example, your billing and ordering applications print the following message to the log file of their respective application servers.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">[11.01.21 06:12:20:099 MESZ]</span> <span class="nc">J2CA0045E</span><span class="p">:</span> <span class="nc">Connection</span> <span class="n">not</span> <span class="n">available</span> <span class="k">while</span> <span class="n">invoking</span> <span class="n">method</span> <span class="n">queueRequest</span> <span class="k">for</span> <span class="n">resource</span> <span class="n">jdbc</span><span class="p">/</span><span class="n">xxxxxx</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Also, you have an image service that suddenly throws and prints to another application server the following error:</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre><span class="na">[28.01.21 17:47:48:647 MESZ]</span> <span class="n">java</span><span class="p">.</span><span class="n">lang</span><span class="p">.</span><span class="nc">Exception</span><span class="p">:</span> <span class="nc">I</span><span class="p">/</span><span class="nc">O</span> <span class="nc">Exception</span><span class="p">:</span> <span class="n">https</span><span class="p">:</span><span class="c1">//server/imageService</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>Once these documents are indexed into Elasticsearch, the following figure shows an inverted index data structure.</p>

<p><img src="/assets/images/invertedIndex.jpg" alt="inverted-index" class="img-responsive" /></p>

<p><strong>Mapping</strong></p>

<p>In order to be able to treat date fields as dates, numeric fields as numbers, and string fields as full-text or exact-value strings, Elasticsearch needs to know what type of data each field contains. This information is contained in the mapping.</p>

<p><strong>Index Templates</strong></p>

<p>When you create an index template, you tell Elasticsearch which settings and mappings an index should have when it is created.</p>

<p><strong>Shards</strong></p>

<p>Shards are the physical instances of <a href="https://lucene.apache.org/" target="_blank">Apache Lucene</a>, shards take care of the physical storage and retrieval of our data.</p>

<p><strong>Nodes and Cluster</strong></p>

<p>A node is a running instance of Elasticsearch, while a cluster consists of one or more nodes with the same cluster.name that are working together to share their data and workload.</p>

<p><strong>Hot-warm architecture</strong></p>

<p>Hot-warm architecture is a way to separate an Elasticsearch deployment into “hot” data nodes and “warm” data nodes.</p>

<p>In Hot nodes, You are actively querying and writing to your index.</p>

<p>In Warm nodes, You are still querying your index, but it is read-only.</p>

<p>In Cold nodes, You are querying your index less frequently. You can deploy it to less performant hardware.</p>

<p>We can balance indexing and query performance in Elasticsearch with a hot-warm architecture.</p>

<h2 id="jvm-logs">JVM Logs</h2>

<p>The JVM logs are created by redirecting the System.out and System.err streams of the JVM to independent log files. The System.out log is used to monitor the health of the running application server. The System.err log contains exception stack trace information for problem analysis.</p>

<h2 id="problem">Problem</h2>

<p>When we need to identify bottlenecks, errors, heavy traffic issues, slow-running queries, connection pooling problems, and more, we usually analyze our application server <em>logs</em>.
But this task is tedious because the <em>log files</em> are distributed in a cluster that contains several application servers with their applications. Depending on each application server product, rotating policies for regenerating a <em>log file</em> cause historical records to be lost - data retention period.</p>

<p><img src="/assets/images/logFileRotation.JPG" alt="logFileRotation" class="img-responsive" /></p>

<p>If every business area has its cluster, the licenses and number of application servers are exponential.</p>

<h2 id="solution--hot-warm-architecture-for-log-analytics-with-elasticsearch">Solution : Hot-warm architecture for log analytics with Elasticsearch</h2>

<p>We are going to install a Hot-Warm-Cold Logging Cluster on the Elasticsearch Service as shown in the following figure.</p>

<p><img src="/assets/images/hot-warm-elastic.jpg" alt="hot-warm-architecture" class="img-responsive" /></p>

<div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042" crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9154513114335042" data-ad-slot="6734634393"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<br /></div>

<p>Logs come from multiple sources, such as software applications installed on various application servers.</p>

<h2 id="choosing-the-right-hardware-for-hot-warm-architecture-in-elasticsearch">Choosing the right hardware for hot-warm architecture in Elasticsearch</h2>

<p>We have the following IP addresses (Three Windows Servers):</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">master</span>   <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span>
<span class="n">hotnode</span>  <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.102</span>
<span class="n">coldnode</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.103</span></code></pre></figure>

<p>Open Windows Defender Firewall and add the following rule for the three machines:</p>

<p><img src="/assets/images/firewall.jpg" alt="firewall" class="img-responsive" /></p>

<p>For the <em>hotnode</em> add an extra 5044 port to the rule if you want to install <em>logstash</em> in that machine.</p>

<h3 id="configure-elasticsearch-cluster-settings-at-master-node">Configure Elasticsearch cluster settings at Master Node</h3>

<p>Open …/elasticsearch.yml and copy the following content.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">bootstrap</span><span class="p">.</span><span class="nf">memory_lock</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">cluster</span><span class="p">.</span><span class="nf">initial_master_nodes</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">masternode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="n">cluster</span><span class="p">.</span><span class="nf">name</span><span class="p">:</span> <span class="n">elasticprod</span>
<span class="n">http</span><span class="p">.</span><span class="nf">port</span><span class="p">:</span> <span class="mi">9200</span>
<span class="n">network</span><span class="p">.</span><span class="nf">host</span><span class="p">:</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span>
<span class="n">node</span><span class="p">.</span><span class="nf">data</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">node</span><span class="p">.</span><span class="nf">ingest</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">node</span><span class="p">.</span><span class="nf">master</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">node</span><span class="p">.</span><span class="nf">max_local_storage_nodes</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">node</span><span class="p">.</span><span class="nf">name</span><span class="p">:</span> <span class="n">masternode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="n">path</span><span class="p">.</span><span class="nf">data</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="no">ProgramData</span><span class="p">\</span><span class="no">Elastic</span><span class="p">\</span><span class="no">Elasticsearch</span><span class="p">\</span><span class="n">data</span>
<span class="n">path</span><span class="p">.</span><span class="nf">logs</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="no">ProgramData</span><span class="p">\</span><span class="no">Elastic</span><span class="p">\</span><span class="no">Elasticsearch</span><span class="p">\</span><span class="n">logs</span>
<span class="n">transport</span><span class="p">.</span><span class="nf">tcp</span><span class="p">.</span><span class="nf">port</span><span class="p">:</span> <span class="mi">9300</span>
<span class="n">xpack</span><span class="p">.</span><span class="nf">license</span><span class="p">.</span><span class="nf">self_generated</span><span class="p">.</span><span class="nf">type</span><span class="p">:</span> <span class="n">basic</span>
<span class="n">xpack</span><span class="p">.</span><span class="nf">security</span><span class="p">.</span><span class="nf">enabled</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">discovery</span><span class="p">.</span><span class="nf">seed_hosts</span><span class="p">:</span> <span class="p">[</span><span class="s2">"110.1.0.102:9300"</span><span class="p">,</span> <span class="s2">"110.1.0.103:9300"</span><span class="p">]</span>
<span class="n">path</span><span class="p">.</span><span class="nf">repo</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="n">repo</span></code></pre></figure>

<div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042" crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9154513114335042" data-ad-slot="6734634393"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<br /></div>

<p>Check the installation with the following command:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">C</span><span class="p">:\</span><span class="o">...</span><span class="p">\</span><span class="n">codersite</span><span class="p">.</span><span class="nf">dev</span><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="no">XGET</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cat</span><span class="o">/</span><span class="n">health?v</span><span class="o">=</span><span class="kp">true</span>
<span class="n">epoch</span>      <span class="n">timestamp</span> <span class="n">cluster</span>     <span class="n">status</span> <span class="n">node</span><span class="p">.</span><span class="nf">total</span> <span class="n">node</span><span class="p">.</span><span class="nf">data</span> <span class="n">shards</span> <span class="n">pri</span> <span class="n">relo</span> <span class="n">init</span> <span class="n">unassign</span> <span class="n">pending_tasks</span> <span class="n">max_task_wait_time</span> <span class="n">active_shards_percent</span>
<span class="mi">1611057767</span> <span class="mi">12</span><span class="p">:</span><span class="mo">02</span><span class="p">:</span><span class="mi">47</span>  <span class="n">elasticprod</span> <span class="n">green</span>           <span class="mi">1</span>         <span class="mi">0</span>      <span class="mi">0</span>   <span class="mi">0</span>    <span class="mi">0</span>    <span class="mi">0</span>        <span class="mi">0</span>             <span class="mi">0</span>                  <span class="o">-</span>                <span class="mf">100.0</span><span class="o">%</span></code></pre></figure>

<h3 id="configure-elasticsearch-cluster-settings-at-hot-node">Configure Elasticsearch cluster settings at Hot Node</h3>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">bootstrap</span><span class="p">.</span><span class="nf">memory_lock</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">cluster</span><span class="p">.</span><span class="nf">name</span><span class="p">:</span> <span class="n">elasticprod</span>
<span class="n">discovery</span><span class="p">.</span><span class="nf">seed_hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span><span class="p">:</span><span class="mi">9300</span>
  <span class="o">-</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.103</span><span class="p">:</span><span class="mi">9300</span>
<span class="n">http</span><span class="p">.</span><span class="nf">port</span><span class="p">:</span> <span class="mi">9200</span>
<span class="n">network</span><span class="p">.</span><span class="nf">host</span><span class="p">:</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.102</span><span class="p">:</span><span class="mi">9300</span>
<span class="n">node</span><span class="p">.</span><span class="nf">data</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">node</span><span class="p">.</span><span class="nf">ingest</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">node</span><span class="p">.</span><span class="nf">master</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">node</span><span class="p">.</span><span class="nf">max_local_storage_nodes</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">node</span><span class="p">.</span><span class="nf">name</span><span class="p">:</span> <span class="n">hotnode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="n">path</span><span class="p">.</span><span class="nf">data</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="no">ProgramData</span><span class="p">\</span><span class="no">Elastic</span><span class="p">\</span><span class="no">Elasticsearch</span><span class="p">\</span><span class="n">data</span>
<span class="n">path</span><span class="p">.</span><span class="nf">logs</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="no">ProgramData</span><span class="p">\</span><span class="no">Elastic</span><span class="p">\</span><span class="no">Elasticsearch</span><span class="p">\</span><span class="n">logs</span>
<span class="n">transport</span><span class="p">.</span><span class="nf">tcp</span><span class="p">.</span><span class="nf">port</span><span class="p">:</span> <span class="mi">9300</span>
<span class="n">xpack</span><span class="p">.</span><span class="nf">license</span><span class="p">.</span><span class="nf">self_generated</span><span class="p">.</span><span class="nf">type</span><span class="p">:</span> <span class="n">basic</span>
<span class="n">xpack</span><span class="p">.</span><span class="nf">security</span><span class="p">.</span><span class="nf">enabled</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">cluster</span><span class="p">.</span><span class="nf">initial_master_nodes</span><span class="p">:</span> <span class="n">masternode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="n">path</span><span class="p">.</span><span class="nf">repo</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="n">repo</span>
<span class="n">node</span><span class="p">.</span><span class="nf">attr</span><span class="p">.</span><span class="nf">box_type</span><span class="p">:</span> <span class="n">hot</span></code></pre></figure>

<p>Check the installation with the following command:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">C</span><span class="p">:\</span><span class="o">...</span><span class="p">\</span><span class="n">codersite</span><span class="p">.</span><span class="nf">dev</span><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="no">XGET</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cat</span><span class="o">/</span><span class="n">nodes</span>
<span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span> <span class="mi">4</span> <span class="mi">66</span> <span class="mi">0</span>    <span class="n">lmr</span>      <span class="o">*</span> <span class="n">masternode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="mf">110.1</span><span class="o">.</span><span class="mf">0.102</span> <span class="mi">1</span> <span class="mi">60</span> <span class="mi">8</span>    <span class="n">cdhlrstw</span> <span class="o">-</span> <span class="n">hotnode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span></code></pre></figure>

<div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042" crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9154513114335042" data-ad-slot="6734634393"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<br /></div>

<h3 id="configure-elasticsearch-cluster-settings-at-cold-node">Configure Elasticsearch cluster settings at Cold Node</h3>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">bootstrap</span><span class="p">.</span><span class="nf">memory_lock</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">cluster</span><span class="p">.</span><span class="nf">name</span><span class="p">:</span> <span class="n">elasticprod</span>
<span class="n">discovery</span><span class="p">.</span><span class="nf">seed_hosts</span><span class="p">:</span>
  <span class="o">-</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span><span class="p">:</span><span class="mi">9300</span>
  <span class="o">-</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.102</span><span class="p">:</span><span class="mi">9300</span>
<span class="n">http</span><span class="p">.</span><span class="nf">port</span><span class="p">:</span> <span class="mi">9200</span>
<span class="n">network</span><span class="p">.</span><span class="nf">host</span><span class="p">:</span> <span class="mf">110.1</span><span class="o">.</span><span class="mf">0.103</span>
<span class="n">node</span><span class="p">.</span><span class="nf">data</span><span class="p">:</span> <span class="kp">true</span>
<span class="n">node</span><span class="p">.</span><span class="nf">ingest</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">node</span><span class="p">.</span><span class="nf">master</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">node</span><span class="p">.</span><span class="nf">max_local_storage_nodes</span><span class="p">:</span> <span class="mi">1</span>
<span class="n">node</span><span class="p">.</span><span class="nf">name</span><span class="p">:</span> <span class="n">coldnode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="n">path</span><span class="p">.</span><span class="nf">data</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="no">ProgramData</span><span class="p">\</span><span class="no">Elastic</span><span class="p">\</span><span class="no">Elasticsearch</span><span class="p">\</span><span class="n">data</span>
<span class="n">path</span><span class="p">.</span><span class="nf">logs</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="no">ProgramData</span><span class="p">\</span><span class="no">Elastic</span><span class="p">\</span><span class="no">Elasticsearch</span><span class="p">\</span><span class="n">logs</span>
<span class="n">transport</span><span class="p">.</span><span class="nf">tcp</span><span class="p">.</span><span class="nf">port</span><span class="p">:</span> <span class="mi">9300</span>
<span class="n">xpack</span><span class="p">.</span><span class="nf">license</span><span class="p">.</span><span class="nf">self_generated</span><span class="p">.</span><span class="nf">type</span><span class="p">:</span> <span class="n">basic</span>
<span class="n">xpack</span><span class="p">.</span><span class="nf">security</span><span class="p">.</span><span class="nf">enabled</span><span class="p">:</span> <span class="kp">false</span>
<span class="n">cluster</span><span class="p">.</span><span class="nf">initial_master_nodes</span><span class="p">:</span> <span class="n">masternode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="n">path</span><span class="p">.</span><span class="nf">repo</span><span class="p">:</span> <span class="no">E</span><span class="p">:\</span><span class="n">repo</span>
<span class="n">node</span><span class="p">.</span><span class="nf">attr</span><span class="p">.</span><span class="nf">box_type</span><span class="p">:</span> <span class="n">cold</span></code></pre></figure>

<p>Check the installation with the following command:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">C</span><span class="p">:\</span><span class="o">...</span><span class="p">\</span><span class="n">codersite</span><span class="p">.</span><span class="nf">dev</span><span class="o">&gt;</span><span class="n">curl</span> <span class="o">-</span><span class="no">XGET</span> <span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span><span class="p">:</span><span class="mi">9200</span><span class="o">/</span><span class="n">_cat</span><span class="o">/</span><span class="n">nodes</span>
<span class="mf">110.1</span><span class="o">.</span><span class="mf">0.101</span> <span class="mi">5</span> <span class="mi">66</span>  <span class="mi">0</span>    <span class="n">lmr</span>      <span class="o">*</span> <span class="n">masternode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="mf">110.1</span><span class="o">.</span><span class="mf">0.102</span> <span class="mi">1</span> <span class="mi">60</span>  <span class="mi">0</span>    <span class="n">cdhlrstw</span> <span class="o">-</span> <span class="n">hotnode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span>
<span class="mf">110.1</span><span class="o">.</span><span class="mf">0.103</span> <span class="mi">2</span> <span class="mi">66</span> <span class="mi">25</span>    <span class="n">cdhlrstw</span> <span class="o">-</span> <span class="n">coldnode</span><span class="p">.</span><span class="nf">codersite</span><span class="p">.</span><span class="nf">dev</span></code></pre></figure>

<p>Please donate to maintain and improve this website if you find this content valuable.</p>

<form action="https://www.paypal.com/donate" method="post" target="_top">
 <input type="hidden" name="hosted_button_id" value="UF4T364RTPPMJ" />
 <input type="image" src="https://www.paypalobjects.com/en_US/DK/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
 <img alt="" border="0" src="https://www.paypal.com/en_DE/i/scr/pixel.gif" width="1" height="1" />
</form>
<p><br /></p>

<p>Before we define Index Templates and configure our Index Lifecycle Policies, we must install the Kibana product.</p>

<h2 id="installation-and-configuration-of-kibana">Installation and configuration of Kibana</h2>

<p>Kibana enables to us navigate through our data (log files)</p>

<p>We have installed kibana using a <a href="https://www.elastic.co/downloads/kibana" target="_blank">zip</a> package.</p>

<p>Check that the following lines are included and activated in the kibana.yml file.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">C</span><span class="p">:\</span><span class="o">&lt;</span><span class="n">kibana</span><span class="o">-</span><span class="n">folder</span><span class="o">&gt;</span><span class="p">\</span><span class="n">config</span><span class="p">\</span><span class="n">kibana</span><span class="p">.</span><span class="nf">yml</span> <span class="n">file</span></code></pre></figure>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">server</span><span class="p">.</span><span class="nf">port</span><span class="p">:</span> <span class="mi">9340</span>
<span class="n">server</span><span class="p">.</span><span class="nf">host</span><span class="p">:</span> <span class="s2">"110.1.0.104"</span>
<span class="n">elasticsearch</span><span class="p">.</span><span class="nf">hosts</span><span class="p">:</span> <span class="s2">"110.1.0.101:9200"</span></code></pre></figure>

<p>To run kibana, execute the following command:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">C</span><span class="p">:\</span><span class="o">&lt;</span><span class="n">kibana</span><span class="o">-</span><span class="n">folder</span><span class="o">&gt;</span><span class="p">\</span><span class="n">bin</span><span class="o">&gt;</span><span class="n">kibana</span><span class="p">.</span><span class="nf">bat</span></code></pre></figure>

<p>From our local workstations we can access kibana in our browsers using the following url:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">http</span><span class="ss">:/</span><span class="o">/</span><span class="mf">110.1</span><span class="o">.</span><span class="mf">0.104</span><span class="p">:</span><span class="mi">9340</span><span class="o">/</span></code></pre></figure>

<p><strong>Creating index templates</strong></p>

<p>We must create and configure our index templates prior to index creation.</p>

<p>From <strong>Stack Management</strong> -&gt; <strong>Index Management</strong> -&gt; <strong>Index Templates</strong>, we create a new index template for our billing application log files.</p>

<p><img src="/assets/images/billingTemplate.jpg" alt="billing-template" class="img-responsive" /></p>

<p>The following snippet code is the final template for new indices whose names match the <strong>billing</strong>* index pattern. Every time Elasticsearch receive a log file, it transforms it into an index by applying the following 
settings:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="s2">"template"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"settings"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"index"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"lifecycle"</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">"name"</span><span class="p">:</span> <span class="s2">"billing_policy"</span>
        <span class="p">},</span>
        <span class="s2">"number_of_replicas"</span><span class="p">:</span> <span class="s2">"0"</span><span class="p">,</span>
        <span class="s2">"routing"</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">"allocation"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"require"</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">"box_type"</span><span class="p">:</span> <span class="s2">"hot"</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"mappings"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"properties"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"was_date"</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"date"</span><span class="p">,</span>
          <span class="s2">"format"</span><span class="p">:</span> <span class="s2">"dd.MM.yy HH:mm:ss:SSS"</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="s2">"aliases"</span><span class="p">:</span> <span class="p">{}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>The <em>routing</em> attribute lets you see which <em>data tier</em> the new indices are allocated to. In our Hot-warm architecture, this will be the Hot Node (<em>box_type</em> attribute).</p>

<p>The snippet code also defines a <em>lifecycle</em> to automate when and how to transition an index through our nodes.</p>

<h3 id="data-lifecycle-management-in-elasticsearch">Data lifecycle management in Elasticsearch</h3>

<p><strong>ILM: Manage the index lifecycle</strong></p>

<p>We can create and apply Index Lifecycle Management (ILM) policies to automatically manage our indices following our retention requirements.</p>

<p>We create a billing policy that defines how to move your data through the following phases.</p>

<p><img src="/assets/images/hotPhase.jpg" alt="hot-phase" class="img-responsive" /></p>

<p>We want to move our data index to the <strong>Cold Node</strong> after 30 days from the index’s rollover.</p>

<p><img src="/assets/images/coldPhase.jpg" alt="cold-phase" class="img-responsive" /></p>

<p>If we want to configure a <strong>Delete phase</strong>, we must enable the “Delete data after this phase” label.</p>

<p>In this Cold phase, we also need to select the node attribute we defined for the Cold Node.</p>

<p><img src="/assets/images/dataAllocation.jpg" alt="data-allocation" class="img-responsive" /></p>

<p>Finally, to save space on our machines, we define a <strong>Delete phase</strong> to delete our data index after 60 days from the index’s rollover.</p>

<p><img src="/assets/images/deletePhase.jpg" alt="delete-phase" class="img-responsive" /></p>

<p>Now our index templates and lifecycle policies are ready. Let’s now move on to the <em>sources</em> where the log files come from to Elasticsearch.</p>

<blockquote>
  <p>Dependency is the key problem in software development. – <cite>Software Design, The Art of managing dependencies and Abstractions.</cite></p>
</blockquote>

<div><p>Here’s a Quick Guide to Elevate Your Projects with Proven Software Design Tactics!.</p>
<center>
  <a href="https://amzn.to/3q7otGe" target="_blank"><img style="border:1px solid black;" alt="codersite" border="0" width="265" height="380" src="../assets/images/SoftwareDesignPortadaJPG.jpg" /></a>
</center>

<br /></div>

<h2 id="using-logstash-to-extract-transform-and-load-data">Using Logstash to Extract, Transform, and Load Data</h2>

<p>Logstash allow us to collect data (log files) from different sources (application servers), and can be enriched, transformed, filtered and moved to elasticsearch.</p>

<p>We have installed logstash using a <a href="https://www.elastic.co/downloads/logstash" target="_blank">zip</a> package.</p>

<p>Logstash will be the receiver for log data from sources such as Beats Agents installed on the Java application servers.</p>

<p>We need to create a <em>pipeline</em> (config file) in which we define an <em>input</em> (collect data), a <em>filter</em> (data transformation), and an <em>output</em> (load data into elastic).</p>

<p><img src="/assets/images/logstashPipeline.jpg" alt="logstash-pipeline" class="img-responsive" /></p>

<p>Before we create the Logstash pipeline, we’ll configure a Beat Agent called Filebeat to send log lines to Logstash.</p>

<h3 id="configuring-filebeat-to-send-log-lines-to-logstash">Configuring Filebeat to Send Log Lines to Logstash</h3>

<p>Filebeat is a lightweight shipper for forwarding and centralizing log data. Installed as an agent (service) on our Java application servers, Filebeat monitors the log files, collects log events, and forwards them to Logstash for indexing.</p>

<p>We have installed Filebeat with Windows <a href="https://www.elastic.co/downloads/beats/filebeat" target="_blank">MSI</a> Installer, establishing it as a Windows service.</p>

<p>Open the <em>filebeat.yml</em> file in your Filebeat installation directory and replace the content with the following lines. Make sure the paths point to the application server log files.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">filebeat</span><span class="p">.</span><span class="nf">inputs</span><span class="p">:</span>
<span class="o">-</span> <span class="ss">type: </span><span class="n">log</span>
  <span class="ss">paths:
    </span><span class="o">-</span> <span class="sr">/path/</span><span class="n">to</span><span class="o">/</span><span class="n">logs</span><span class="o">/</span><span class="n">billingServer</span><span class="o">/</span><span class="no">SystemOut</span><span class="p">.</span><span class="nf">log</span>
<span class="n">output</span><span class="p">.</span><span class="nf">logstash</span><span class="p">:</span>
  <span class="ss">hosts: </span><span class="p">[</span><span class="s2">"110.1.0.102:5044"</span><span class="p">]</span>
  <span class="n">ilm</span><span class="p">.</span><span class="nf">enabled</span><span class="p">:</span> <span class="kp">true</span></code></pre></figure>

<p>The log files that Filebeat processes are redirected - output - to the machine where we will install Logstash.</p>

<p>On Windows machines, the absolute path to the log files looks like the following line:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby">  <span class="ss">paths:
    </span><span class="o">-</span> <span class="s2">"C:</span><span class="se">\\</span><span class="s2">path</span><span class="se">\\</span><span class="s2">to</span><span class="se">\\</span><span class="s2">logs</span><span class="se">\\</span><span class="s2">billingServer</span><span class="se">\\</span><span class="s2">SystemOut.log"</span></code></pre></figure>

<p>At the application servers machines (data source), run Filebeat with the following command.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">sudo</span> <span class="p">.</span><span class="nf">/</span><span class="n">filebeat</span> <span class="o">-</span><span class="n">e</span> <span class="o">-</span><span class="n">c</span> <span class="n">filebeat</span><span class="p">.</span><span class="nf">yml</span> <span class="o">-</span><span class="n">d</span> <span class="s2">"publish"</span></code></pre></figure>

<p>Filebeat will attempt to connect Logstash on port 5044.</p>

<h3 id="configuring-logstash-for-filebeat-input">Configuring Logstash for Filebeat Input</h3>

<p>Next, we create a primary Logstash configuration pipeline that uses the Beats input plugin to receive events from the application servers and an output section to write to Elasticsearch.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">input</span> <span class="p">{</span>
  <span class="n">beats</span> <span class="p">{</span>
    <span class="n">port</span> <span class="o">=&gt;</span> <span class="mi">5044</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="c1"># The filter part of this file is commented out to indicate that it is optional.</span>
<span class="c1"># filter {</span>
<span class="c1">#</span>
<span class="c1"># }</span>
<span class="n">output</span> <span class="p">{</span>
  <span class="n">stdout</span> <span class="p">{</span> <span class="n">codec</span> <span class="o">=&gt;</span> <span class="n">rubydebug</span> <span class="p">}</span>
  <span class="n">elasticsearch</span> <span class="p">{</span>
    <span class="n">hosts</span> <span class="o">=&gt;</span> <span class="p">[</span> <span class="s2">"110.1.0.101:9200"</span> <span class="p">]</span> 
    <span class="n">index</span> <span class="o">=&gt;</span> <span class="s2">"billing-%{[@metadata][version]}"</span>
    <span class="n">ilm_policy</span> <span class="o">=&gt;</span> <span class="s2">"billing_policy"</span>
    <span class="n">action</span> <span class="o">=&gt;</span> <span class="s2">"create"</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>Tu run logstash, execute the following command.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">C</span><span class="p">:\</span><span class="o">&lt;</span><span class="n">logstash</span><span class="o">-</span><span class="n">folder</span><span class="o">&gt;</span><span class="p">\</span><span class="n">bin</span><span class="o">&gt;</span><span class="n">logstash</span> <span class="o">-</span><span class="n">f</span> <span class="o">..</span><span class="p">\</span><span class="n">config</span><span class="p">\</span><span class="n">billing</span><span class="o">-</span><span class="n">pipeline</span><span class="p">.</span><span class="nf">conf</span> <span class="o">--</span><span class="n">config</span><span class="p">.</span><span class="nf">reload</span><span class="p">.</span><span class="nf">automatic</span></code></pre></figure>

<p>With this minimal configuration, you can visualize your log files in Kibana.</p>

<p>Please donate if you find this content valuable.</p>

<form action="https://www.paypal.com/donate" method="post" target="_top">
 <input type="hidden" name="hosted_button_id" value="UF4T364RTPPMJ" />
 <input type="image" src="https://www.paypalobjects.com/en_US/DK/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
 <img alt="" border="0" src="https://www.paypal.com/en_DE/i/scr/pixel.gif" width="1" height="1" />
</form>
<p><br /></p>

<p><strong>Customizing the filter</strong></p>

<p>To use logs data from Elastic to set up a rate-limit algorithm, we need to parse it using filter plugins.</p>

<p>We want to know how many requests for every endpoint and client arrive at our application servers by month, day, hour, minute, and second.</p>

<p><strong>Grok filter</strong></p>

<p>Grok combines text patterns into something that matches your logs.</p>

<p>Grok pattern: %{<em>SYNTAX</em>:<em>SEMANTIC</em>}</p>

<p>The <em>SYNTAX</em> is the name of the pattern that will match your text.</p>

<p>The <em>SEMANTIC</em> is the identifier you give to the matched piece of text.</p>

<p>For example, we can pull out fields from a server log file.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="mf">55.3</span><span class="o">.</span><span class="mf">244.1</span> <span class="p">[</span><span class="mf">19.08</span><span class="o">.</span><span class="mi">22</span> <span class="mo">05</span><span class="p">:</span><span class="mi">13</span><span class="p">:</span><span class="mi">42</span> <span class="o">+</span><span class="mo">0000</span><span class="p">]</span> <span class="n">codersite</span><span class="p">.</span><span class="nf">dev</span> <span class="no">GET</span> <span class="sr">/v1/</span><span class="n">api</span><span class="o">/</span><span class="n">billings</span> <span class="mi">15824</span> <span class="mf">0.043</span></code></pre></figure>

<p>The filter section inside logstash pipeline looks like the following.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">filter</span> <span class="p">{</span>
  <span class="n">grok</span> <span class="p">{</span>
    <span class="n">match</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="s2">"message"</span> <span class="o">=&gt;</span> <span class="s2">"%{IP:client} %{DATA:timestamp} %{WORD:client} %{WORD:method} %{URIPATHPARAM:endpoint} %{NUMBER:bytes} %{NUMBER:duration}"</span> <span class="p">}</span>
  <span class="p">}</span>
  
  <span class="n">grok</span> <span class="p">{</span>
    <span class="n">match</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s2">"timestamp"</span><span class="p">,</span> <span class="s2">"%{WORD:was_dd}.%{WORD:was_MM}.%{WORD:was_yy} %{SPACE}%{WORD:was_HH}:%{WORD:was_mm}:%{WORD:was_ss}"</span><span class="p">]</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<p>We build an aggregation that summarizes our data. The following search runs a terms aggregation on “codersite.dev” client.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="no">GET</span> <span class="p">.</span><span class="nf">ds</span><span class="o">-</span><span class="n">billing</span><span class="o">-</span><span class="n">index</span><span class="o">-</span><span class="mo">000006</span><span class="o">/</span><span class="n">_search</span>
<span class="p">{</span>
  <span class="s2">"size"</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> 
  <span class="s2">"query"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"match"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"client.keyword"</span><span class="p">:</span> <span class="s2">"codersite.dev"</span>
    <span class="p">}</span>
  <span class="p">},</span>
  <span class="s2">"aggs"</span><span class="p">:</span> <span class="p">{</span>
    <span class="s2">"all_clients"</span><span class="p">:</span> <span class="p">{</span>
      <span class="s2">"terms"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"field"</span><span class="p">:</span> <span class="s2">"client.keyword"</span>
      <span class="p">},</span>
      <span class="s2">"aggs"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"all_endpoints"</span><span class="p">:</span> <span class="p">{</span>
          <span class="s2">"terms"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"field"</span><span class="p">:</span> <span class="s2">"endpoint.keyword"</span>
          <span class="p">},</span>
          <span class="s2">"aggs"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"all_was_years"</span><span class="p">:</span> <span class="p">{</span>
              <span class="s2">"terms"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"field"</span><span class="p">:</span> <span class="s2">"was_yy.keyword"</span>
              <span class="p">},</span>
              <span class="s2">"aggs"</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">"all_was_months"</span><span class="p">:</span> <span class="p">{</span>
                  <span class="s2">"terms"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"field"</span><span class="p">:</span> <span class="s2">"was_MM.keyword"</span>
                  <span class="p">},</span>
                  <span class="s2">"aggs"</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">"all_was_days"</span><span class="p">:</span> <span class="p">{</span>
                      <span class="s2">"terms"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"field"</span><span class="p">:</span> <span class="s2">"was_dd.keyword"</span>
                      <span class="p">},</span>
                      <span class="s2">"aggs"</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"all_was_hours"</span><span class="p">:</span> <span class="p">{</span>
                          <span class="s2">"terms"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">"field"</span><span class="p">:</span> <span class="s2">"was_HH.keyword"</span>
                          <span class="p">},</span>
                          <span class="s2">"aggs"</span><span class="p">:</span> <span class="p">{</span>
                            <span class="s2">"all_was_minutes"</span><span class="p">:</span> <span class="p">{</span>
                              <span class="s2">"terms"</span><span class="p">:</span> <span class="p">{</span>
                                <span class="s2">"field"</span><span class="p">:</span> <span class="s2">"was_mm.keyword"</span>
                              <span class="p">}</span>         
                            <span class="p">}</span>
                          <span class="p">}</span>
                        <span class="p">}</span>
                      <span class="p">}</span>
                    <span class="p">}</span>
                  <span class="p">}</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">}</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span></code></pre></figure>

<div><center>
  <a href="https://amzn.to/3QYUK0v" target="_blank"><img style="border:1px solid black;" alt="codersite" border="0" src="../assets/images/adsJavaInterview1.jpg" /></a>
</center>

<br /></div>

<p>Aggregation results are in the response’s aggregations object.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="p">{</span>
  <span class="s2">"took"</span> <span class="p">:</span> <span class="mi">1253</span><span class="p">,</span>
  <span class="s2">"timed_out"</span> <span class="p">:</span> <span class="kp">false</span><span class="p">,</span>
  <span class="s2">"_shards"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">"total"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"successful"</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
    <span class="s2">"skipped"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
    <span class="s2">"failed"</span> <span class="p">:</span> <span class="mi">0</span>
  <span class="p">},</span>
  <span class="s2">"hits"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">"total"</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">"value"</span> <span class="p">:</span> <span class="mi">10000</span><span class="p">,</span>
      <span class="s2">"relation"</span> <span class="p">:</span> <span class="s2">"gte"</span>
    <span class="p">},</span>
    <span class="s2">"max_score"</span> <span class="p">:</span> <span class="n">null</span><span class="p">,</span>
    <span class="s2">"hits"</span> <span class="p">:</span> <span class="p">[</span> <span class="p">]</span>
  <span class="p">},</span>
  <span class="s2">"aggregations"</span> <span class="p">:</span> <span class="p">{</span>
    <span class="s2">"all_clients"</span> <span class="p">:</span> <span class="p">{</span>
      <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
      <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
          <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"codersite.dev"</span><span class="p">,</span>
          <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">2310409</span><span class="p">,</span>
          <span class="s2">"all_endpoints"</span> <span class="p">:</span> <span class="p">{</span>
            <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
              <span class="p">{</span>
                <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"/v1/api/billings"</span><span class="p">,</span>
                <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">2309966</span><span class="p">,</span>
                <span class="s2">"all_was_years"</span> <span class="p">:</span> <span class="p">{</span>
                  <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                      <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"23"</span><span class="p">,</span>
                      <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">2309966</span><span class="p">,</span>
                      <span class="s2">"all_was_months"</span> <span class="p">:</span> <span class="p">{</span>
                        <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                        <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
                          <span class="p">{</span>
                            <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"09"</span><span class="p">,</span>
                            <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">1516918</span><span class="p">,</span>
                            <span class="s2">"all_was_days"</span> <span class="p">:</span> <span class="p">{</span>
                              <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                              <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">712935</span><span class="p">,</span>
                              <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
                                <span class="p">{</span>
                                  <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"13"</span><span class="p">,</span>
                                  <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">80457</span><span class="p">,</span>
                                  <span class="s2">"all_was_hours"</span> <span class="p">:</span> <span class="p">{</span>
                                    <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                    <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
                                      <span class="p">{</span>
                                        <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"06"</span><span class="p">,</span>
                                        <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">10061</span><span class="p">,</span>
                                        <span class="s2">"all_was_minutes"</span> <span class="p">:</span> <span class="p">{</span>
                                          <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">1146</span><span class="p">,</span>
                                          <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
                                            <span class="p">{</span>
                                              <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"17"</span><span class="p">,</span>
                                              <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">939</span>
                                            <span class="p">},</span>
                                            <span class="p">{</span>
                                              <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"18"</span><span class="p">,</span>
                                              <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">916</span>
                                            <span class="p">},</span>
                                            <span class="p">{</span>
                                              <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"26"</span><span class="p">,</span>
                                              <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">840</span>
                                            <span class="p">}</span>
                                          <span class="p">]</span>
                                        <span class="p">}</span>
                                      <span class="p">},</span>
                                      <span class="p">{</span>
                                        <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"21"</span><span class="p">,</span>
                                        <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">10061</span><span class="p">,</span>
                                        <span class="s2">"all_was_minutes"</span> <span class="p">:</span> <span class="p">{</span>
                                          <span class="s2">"doc_count_error_upper_bound"</span> <span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="s2">"sum_other_doc_count"</span> <span class="p">:</span> <span class="mi">1461</span><span class="p">,</span>
                                          <span class="s2">"buckets"</span> <span class="p">:</span> <span class="p">[</span>
                                            <span class="p">{</span>
                                              <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"18"</span><span class="p">,</span>
                                              <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">889</span>
                                            <span class="p">},</span>
                                            <span class="p">{</span>
                                              <span class="s2">"key"</span> <span class="p">:</span> <span class="s2">"19"</span><span class="p">,</span>
                                              <span class="s2">"doc_count"</span> <span class="p">:</span> <span class="mi">882</span>
                                            <span class="p">}</span>
										  <span class="p">]</span>
                                        <span class="p">}</span>
                                      <span class="p">}</span>
                                    <span class="p">]</span>
                                  <span class="p">}</span>
                                <span class="p">}</span>
                              <span class="p">]</span>
                            <span class="p">}</span>
                          <span class="p">}</span>
                        <span class="p">]</span>
                      <span class="p">}</span>
                    <span class="p">}</span>
                  <span class="p">]</span>
                <span class="p">}</span>
              <span class="p">}</span>
            <span class="p">]</span>
          <span class="p">}</span>
        <span class="p">}</span>
      <span class="p">]</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>									</code></pre></figure>

<p>From the buckets per minute, we can see codersite.dev client sends an average of 893 requests per minute.</p>

<p>Based on these accurate statistics and analyses, you know how to limit the number of requests allowed per client + endpoint. In this way, you can protect your software infrastructure from possible attacks or overuse of hardware resources.</p>

<p>Learn <a href="https://codersite.dev/rate-limit/" target="_blank">here</a> how to implement a RateLimit algorithm.</p>

<p>Now that you have centralized all server logs in only one cluster, you can monitor or diagnose possible errors. Kibana will inform you about all application servers’ errors in one unified report.</p>

<p>Please donate if you find this content valuable.</p>

<form action="https://www.paypal.com/donate" method="post" target="_top">
 <input type="hidden" name="hosted_button_id" value="UF4T364RTPPMJ" />
 <input type="image" src="https://www.paypalobjects.com/en_US/DK/i/btn/btn_donateCC_LG.gif" border="0" name="submit" title="PayPal - The safer, easier way to pay online!" alt="Donate with PayPal button" />
 <img alt="" border="0" src="https://www.paypal.com/en_DE/i/scr/pixel.gif" width="1" height="1" />
</form>
<p><br /></p>

				<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042"
     crossorigin="anonymous"></script>
<!-- ad below post -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9154513114335042"
     data-ad-slot="2720551629"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2021-02-26">26 Feb 2021</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#distribuited-systems">distribuited systems</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="http://localhost:4000/clean-code/"> &laquo; Best practices for writing Clean Code</a>
            
            
            <a class="next d-block col-md-6 text-lg-right" href="http://localhost:4000/merge-two-sorted-lists/">Merge two sorted lists algorithm &raquo; </a>
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


<!-- Bottom Alert Bar
================================================== -->
<!--<div class="alertbar">-->
	<div class="container text-center">
		<span><a class="navbar-brand" href="/"><img src="/assets/images/logo.svg" height="30" alt="codersite"></a> &nbsp; Stay Connected!. Follow me to get my latest articles.</span>
        <form action="https://dev.us20.list-manage.com/subscribe/post?u=7ae24fed31c489e82aab00e64&amp;id=8d64d36cba" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
<!--</div>-->

    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">→</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#algorithms">algorithms (7)</a>
                
                    <a class="mt-1 mb-1" href="/categories#test-driven-development">test-driven development (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#design">design (6)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Web-APIs">Web APIs (7)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Coding-Practices">Coding Practices (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#distribuited-systems">distribuited systems (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Object-Oriented">Object-Oriented (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Domain-Driven-Design">Domain-Driven Design (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Language">Language (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Web-Performance">Web Performance (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#startup">startup (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#data-structures">data structures (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#programming">programming (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright © 2024 codersite 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a href="/policy">Privacy policy |</a>
				<a href="/termsOfService">Terms of service |</a>
				<a href="/impressum">Impressum</a>
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
