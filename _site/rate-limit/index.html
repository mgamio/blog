<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

<link rel="icon" href="/assets/images/logo.png">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>How to implement Rate Limiting | codersite</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="How to implement Rate Limiting" />
<meta name="author" content="moises" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Hot to implement an API Rate Limiting in a backend API. Rate Limiting Algorithms" />
<meta property="og:description" content="Hot to implement an API Rate Limiting in a backend API. Rate Limiting Algorithms" />
<link rel="canonical" href="http://localhost:4000/rate-limit/" />
<meta property="og:url" content="http://localhost:4000/rate-limit/" />
<meta property="og:site_name" content="codersite" />
<meta property="og:image" content="http://localhost:4000/assets/images/rateLimitAlgorithm.jpg" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-02-02T00:00:00+01:00" />
<meta name="twitter:card" content="summary_large_image" />
<meta property="twitter:image" content="http://localhost:4000/assets/images/rateLimitAlgorithm.jpg" />
<meta property="twitter:title" content="How to implement Rate Limiting" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"moises"},"dateModified":"2023-02-02T00:00:00+01:00","datePublished":"2023-02-02T00:00:00+01:00","description":"Hot to implement an API Rate Limiting in a backend API. Rate Limiting Algorithms","headline":"How to implement Rate Limiting","image":"http://localhost:4000/assets/images/rateLimitAlgorithm.jpg","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/rate-limit/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"http://localhost:4000/assets/images/logo.svg"},"name":"moises"},"url":"http://localhost:4000/rate-limit/"}</script>
<!-- End Jekyll SEO tag -->


<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    
<link href="/assets/css/screen.css" rel="stylesheet">

<link href="/assets/css/main.css" rel="stylesheet">

<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/site.webmanifest">

<script src="/assets/js/jquery.min.js"></script>
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042"
  crossorigin="anonymous"></script></head>





<body class="layout-post">
	<!-- defer loading of font and font awesome -->
	<noscript id="deferred-styles">
		<link href="https://fonts.googleapis.com/css?family=Righteous%7CMerriweather:300,300i,400,400i,700,700i" rel="stylesheet">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">
	</noscript>


<!-- Begin Menu Navigation
================================================== -->
<nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top mediumnavigation nav-down">

    <div class="container pr-0">

    <!-- Begin Logo -->
	<a class="navbar-brand" href="/">
    <img src="/assets/images/logo.svg" height="30" alt="codersite">
    </a>
    <!-- End Logo -->
	 
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarMediumish" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="navbarMediumish">

        <!-- Begin Menu -->

            <ul class="navbar-nav ml-auto">

                
                <li class="nav-item">
                
                <a class="nav-link" href="/index.html">Blog</a>
                </li>

                <li class="nav-item">
                <a class="nav-link" href="/about">About</a>
                </li>
 
                <li class="nav-item">
                <a class="nav-link" href="/recommended">Recommended</a>
                </li>
				
                <li class="nav-item">
                <a class="nav-link" href="/book">Books</a>
                </li>

                <script src="/assets/js/lunr.js"></script>


<style>
    .lunrsearchresult .title {color: #d9230f;}
    .lunrsearchresult .url {color: silver;}
    .lunrsearchresult a {display: block; color: #777;}
    .lunrsearchresult a:hover, .lunrsearchresult a:focus {text-decoration: none;}
    .lunrsearchresult a:hover .title {text-decoration: underline;}
</style>


<form class="bd-search" onSubmit="return lunr_search(document.getElementById('lunrsearch').value);">
    <input type="text" class="form-control text-small launch-modal-search" id="lunrsearch" name="q" maxlength="255" value="" placeholder="Type and enter..."/>
</form>

<div id="lunrsearchresults">
    <ul></ul>
</div>

<script src="/assets/js/lunrsearchengine.js"></script>

            </ul>

        <!-- End Menu -->

    </div>

    </div>
</nav>
<!-- End Navigation
================================================== -->
<div class="site-content">

<div class="container">

<!-- Site Title
================================================== --><!-- nothing --><!-- Content
================================================== -->
<div class="main-content">
    <!-- Begin Article
================================================== -->
<div class="container">
    <div class="row">

        <!-- Post Share -->
        <div class="col-md-2 pl-0">
            <div class="share sticky-top sticky-top-offset">
    <p>
        Share
    </p>
    <ul>
        <li class="ml-1 mr-1">
            <a target="_blank" href="https://twitter.com/intent/tweet?text=How to implement Rate Limiting&url=http://localhost:4000/rate-limit/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                <i class="fab fa-twitter"></i>
            </a>
        </li>

        <li class="ml-1 mr-1">
            <a target="_blank" href="https://facebook.com/sharer.php?u=http://localhost:4000/rate-limit/" onclick="window.open(this.href, 'facebook-share', 'width=550,height=435');return false;">
                <i class="fab fa-facebook-f"></i>
            </a>
        </li>

         <li class="ml-1 mr-1">
            <a target="_blank" href="https://www.linkedin.com/shareArticle?mini=true&url=http://localhost:4000/rate-limit/" onclick="window.open(this.href, 'width=550,height=435');return false;">
                <i class="fab fa-linkedin-in"></i>
            </a>
        </li>	
    </ul>
    
</div>

        </div>

        <!-- Post -->
        

        <div class="col-md-9 flex-first flex-md-unordered">
            <div class="mainheading">

                <!-- Author Box -->
                
                <div class="row post-top-meta">
                    <div class="col-xs-12 col-md-3 col-lg-2 text-center text-md-left mb-4 mb-md-0">
                        
                        <img class="author-thumb" src="/assets/images/author.jpg" alt="Moises Gamio">
                        
                    </div>
                    <div class="col-xs-12 col-md-9 col-lg-10 text-center text-md-left">
                        <a target="_blank" class="link-dark" href="https://codersite.dev">Moises Gamio</a><a target="_blank" href="https://twitter.com/MoisesGamio" class="btn follow">Follow</a>
                        <span class="author-description">Software Engineer. Comprehensive experience in all phases of the software development lifecycle for several economic sectors.</span>
                    </div>
                </div>
                

                <!-- Post Title -->
                <h1 class="posttitle">How to implement Rate Limiting</h1>

            </div>

            <!-- Adsense if enabled from _config.yml (change your pub id and slot) -->
			
			
            <!-- End Adsense -->

            <!-- Post Featured Image -->
            

            
            <img class="featured-image img-fluid" src="/assets/images/rateLimitAlgorithm.jpg" alt="How to implement Rate Limiting">
            

            
            <!-- End Featured Image -->

            <!-- Post Content -->
            <div class="article-post">
                <!-- Toc if any -->
                
                <!-- End Toc -->
                <p>A <a href="https://cloud.google.com/architecture/rate-limiting-strategies-techniques" target="_blank">rate-limiting</a> system controls the rate of traffic sent or received on a network interface. APIs will use rate-limiting techniques to control how many times application Clients are allowed to call an API endpoint during a given time interval - Request Limiting. Traffic is allowed up to one specified rate, whereas traffic that exceeds that rate is denied â€“ HTTP code 429.</p>

<h2 id="reasons-to-implement-rate-limiting">Reasons to implement Rate Limiting</h2>

<ul>
  <li>
    <p>Avoid a denial-of-service (DoS) attack. So, the first principle here will be Availability for our distributed systems.</p>
  </li>
  <li>
    <p>We must protect database functions that use expensive hardware resources when the API requests arrive concurrently or sequentially without limit.</p>
  </li>
  <li>
    <p>Limiting Concurrent Requests.</p>
  </li>
</ul>

<h2 id="token-bucket-algorithm">Token-bucket algorithm</h2>

<p>The <a href="https://en.wikipedia.org/wiki/Token_bucket" target="_blank">token-bucket</a> algorithm is explained with the analogy of a bucket with finite capacity, into which tokens are added at a fixed rate. But it canâ€™t fill up infinitely. If a token arrives when the bucket is complete, itâ€™s discarded. On every request, <strong><em>n</em></strong> number of tokens are removed from the bucket. The request is rejected if there are fewer than <strong><em>n</em></strong> tokens in the bucket.</p>

<p>When we have somebody that takes out tokens, we also need somebody that puts tokens into the bucket. The <em>refiller</em> periodically creates new tokens and puts them into the bucket.</p>

<p><img src="/assets/images/rateLimitRefiller.jpg" alt="rate-Limit-Refiller" class="img-responsive" /></p>

<h2 id="about-bucket4j">About Bucket4j</h2>

<p><a href="https://bucket4j.com/8.1.1/toc.html" target="_blank">Bucket4j</a> is a Java rate limiting library implemented on top of ideas of the token-bucket algorithm.</p>

<p>Maven Configuration: We need to add the bucket4j dependency to our pom.xml file.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre></td><td class="rouge-code"><pre><span class="p">&lt;</span><span class="n">dependency</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">groupId</span><span class="p">&gt;</span><span class="n">com</span><span class="p">.</span><span class="n">bucket4j</span><span class="p">&lt;/</span><span class="n">groupId</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">artifactId</span><span class="p">&gt;</span><span class="n">bucket4j-core</span><span class="p">&lt;/</span><span class="n">artifactId</span><span class="p">&gt;</span>
    <span class="p">&lt;</span><span class="n">version</span><span class="p">&gt;</span><span class="mf">8.1.1</span><span class="p">&lt;/</span><span class="n">version</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="n">dependency</span><span class="p">&gt;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042" crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9154513114335042" data-ad-slot="6734634393"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<br /></div>

<p>You can implement a rate limiting for your clients based on subscription plans or even for each endpoint. For learning purposes, we implement a rate limit based on external IPs.</p>

<h2 id="inspirational-quotes-about-tech">Inspirational Quotes About Tech</h2>

<p>We implement a web service allowing clients to retrieve a Random Quote about tech.</p>

<p>Firstly, we define a <em>Repository</em> class to retrieve Quotes data from a text file, for example.</p>

<p>Secondly, we define a <em>Service</em> class to manipulate the previous data and get a random Quote.</p>

<p>Finally, we assemble all these components - dependencies - in a <em>RestContoller</em> class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="nd">@RestController</span>
<span class="nd">@RequestMapping</span><span class="p">(</span><span class="s">"/v1"</span><span class="p">)</span>
<span class="k">public</span> <span class="kd">class</span> <span class="nc">QuoteController</span> <span class="p">{</span>

  <span class="nd">@Autowired</span>
  <span class="k">private</span> <span class="nc">QuoteService</span> <span class="n">quoteService</span><span class="p">;</span>

  <span class="nd">@GetMapping</span><span class="p">(</span><span class="n">value</span> <span class="p">=</span> <span class="s">"/quotes/random"</span><span class="p">,</span> <span class="n">produces</span> <span class="p">=</span> <span class="nc">MediaType</span><span class="p">.</span><span class="nc">APPLICATION_JSON_VALUE</span><span class="p">)</span>
  <span class="k">public</span> <span class="nc">Quote</span> <span class="nf">getQuote</span><span class="p">(</span><span class="nc">HttpServletRequest</span> <span class="n">httpServletRequest</span><span class="p">)</span> <span class="n">throws</span> <span class="nc">Exception</span> <span class="p">{</span>

    <span class="k">return</span> <span class="n">quoteService</span><span class="p">.</span><span class="nf">getRandomQuote</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To <a href="https://codersite.dev/solid-principles-the-definitive-guide/" target="_blank">design more flexible systems</a>, follow my practical guidelines for managing dependencies:</p>

<div><center>
  <a href="https://amzn.to/3q7otGe" target="_blank"><img style="border:1px solid black;" alt="codersite" border="0" width="265" height="380" src="../assets/images/SoftwareDesignPortadaJPG.jpg" /></a>
</center>

<br /></div>

<p>For more information on implementing RESTful web services, visit this <a href="https://codersite.dev/documenting-rest-api-openapi3/" target="_blank">link</a>.</p>

<p>Once you deploy the API service, you can request a random quote from a Web Client like Postman.</p>

<p><img src="/assets/images/randomQuotePostman.jpg" alt="rate-Limit-random" class="img-responsive" /></p>

<p>But in reality, web Clients are automated, especially in B2B integrations, where developers on the client side send hundreds or thousands of requests per minute to analyze random data during the implementation stage.</p>

<p>We should implement a Rate Limiting Algorithm to protect our software infrastructure from unintentional requests that exceed the regular consumption of our web services.</p>

<div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042" crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9154513114335042" data-ad-slot="6734634393"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<br /></div>

<h2 id="implementing-spring-mvc-handlerinterceptor">Implementing Spring MVC HandlerInterceptor</h2>

<p>The <em>preHandle</em> method of a <em>HandlerInterceptor</em> Interface intercepts a client request and adds a preprocess.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre></td><td class="rouge-code"><pre><span class="nd">@Component</span>
<span class="k">public</span> <span class="kd">class</span> <span class="nc">RateLimitInterceptor</span> <span class="n">implements</span> <span class="nc">HandlerInterceptor</span> <span class="p">{</span>
 
  <span class="nd">@Override</span>
  <span class="k">public</span> <span class="n">boolean</span> <span class="nf">preHandle</span><span class="p">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> 
    <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span> <span class="nc">Object</span> <span class="n">handler</span><span class="p">)</span> <span class="n">throws</span> <span class="nc">Exception</span> <span class="p">{</span>
    
	<span class="c1">//preprocess here</span>
    
	<span class="k">return</span> <span class="k">false</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To detect an external IP, we implement the following method.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre></td><td class="rouge-code"><pre>  <span class="k">private</span> <span class="nc">String</span> <span class="nf">getClientIP</span><span class="p">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="p">)</span> <span class="p">{</span>
    <span class="nc">String</span> <span class="n">ip</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">getHeader</span><span class="p">(</span><span class="s">"X-FORWARDED-FOR"</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ip</span> <span class="p">==</span> <span class="k">null</span> <span class="p">||</span> <span class="n">ip</span><span class="p">.</span><span class="nf">isEmpty</span><span class="p">())</span> <span class="p">{</span>
      <span class="n">ip</span> <span class="p">=</span> <span class="n">request</span><span class="p">.</span><span class="nf">getRemoteAddr</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">ip</span><span class="p">;</span>
  <span class="p">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<p>To use the <em>bucket4j</em> library, we need to understand their terminology.</p>

<p><strong>Bucket</strong>  is the Interface that defines the behavior of a rate-limiter - based on the Token Bucket algorithm. A bucket is created using a builder pattern.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="nc">Bucket</span> <span class="n">bucket</span> <span class="p">=</span> <span class="nc">Bucket</span><span class="p">.</span><span class="nf">builder</span><span class="p">()</span>
  <span class="p">.</span><span class="nf">addLimit</span><span class="p">(</span><span class="o">..</span><span class="p">.)</span>
  <span class="p">.</span><span class="nf">build</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>To add a <em>Limit</em> to the bucket, we define a <em>Bandwidth</em> denoted by the following terms.</p>

<p><strong>Capacity</strong> specifies how many tokens your bucket has.</p>

<p><strong>Refill</strong> specifies how fast tokens can be refilled after it was consumed from a bucket.</p>

<p>If we choose the interval refill, the bucket will wait until the whole period is elapsed before regenerating the whole amount of tokens.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="rouge-code"><pre><span class="c1">// generates 10 tokens each minute</span>
<span class="nc">Refill</span><span class="p">.</span><span class="nf">intervally</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nc">Duration</span><span class="p">.</span><span class="nf">ofMinutes</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042" crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9154513114335042" data-ad-slot="6734634393"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<br /></div>

<p>For example, if we decide that <em>one</em> client request represents a token, and the client sends ten requests over the next 15 seconds, then the client must wait 45 seconds to send the following request; otherwise, the API rejects the request. We will see this implementation later.</p>

<p>The following code defines a bucket with 10 tokens of capacity.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre></td><td class="rouge-code"><pre>  <span class="k">private</span> <span class="n">long</span> <span class="n">capacity</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
  <span class="k">private</span> <span class="n">long</span> <span class="n">tokens</span> <span class="p">=</span> <span class="mi">10</span><span class="p">;</span>
  
  <span class="k">private</span> <span class="k">final</span> <span class="nc">Bucket</span> <span class="n">defaultBucket</span> <span class="p">=</span> <span class="nc">Bucket</span><span class="p">.</span><span class="nf">builder</span><span class="p">()</span>
    <span class="p">.</span><span class="nf">addLimit</span><span class="p">(</span><span class="nc">Bandwidth</span><span class="p">.</span><span class="nf">classic</span><span class="p">(</span><span class="n">capacity</span><span class="p">,</span> <span class="nc">Refill</span><span class="p">.</span><span class="nf">intervally</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="nc">Duration</span><span class="p">.</span><span class="nf">ofMinutes</span><span class="p">(</span><span class="mi">1</span><span class="p">))))</span>
    <span class="p">.</span><span class="nf">build</span><span class="p">();</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>We need a <em>hashMap</em> to store the buckets corresponding to each external IP. And we also need a variable that defines how many tokens we can consume from the bucket when a request arrives.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre></td><td class="rouge-code"><pre>  <span class="k">private</span> <span class="k">final</span> <span class="nc">Map</span><span class="p">&lt;</span><span class="nc">String</span><span class="p">,</span> <span class="nc">Bucket</span><span class="p">&gt;</span> <span class="n">buckets</span> <span class="p">=</span> <span class="n">new</span> <span class="nc">ConcurrentHashMap</span><span class="p">&lt;&gt;();</span>
  <span class="k">private</span> <span class="k">final</span> <span class="n">long</span> <span class="n">tokensToConsumeByDefault</span> <span class="p">=</span> <span class="mi">1</span><span class="p">;</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>With all the pieces in place, we implement request preprocessing inside the <em>preHandle</em> method.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="nd">@Override</span>
<span class="k">public</span> <span class="n">boolean</span> <span class="nf">preHandle</span><span class="p">(</span><span class="nc">HttpServletRequest</span> <span class="n">request</span><span class="p">,</span> <span class="nc">HttpServletResponse</span> <span class="n">response</span><span class="p">,</span>
  <span class="nc">Object</span> <span class="n">handler</span><span class="p">)</span> <span class="n">throws</span> <span class="nc">Exception</span> <span class="p">{</span>
						   
  <span class="nc">String</span> <span class="n">clientIP</span> <span class="p">=</span> <span class="nf">getClientIP</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

  <span class="nc">Bucket</span> <span class="n">bucketByClientIP</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">buckets</span><span class="p">.</span><span class="nf">containsKey</span><span class="p">(</span><span class="n">clientIP</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">bucketByClientIP</span> <span class="p">=</span> <span class="n">buckets</span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="n">clientIP</span><span class="p">);</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="n">bucketByClientIP</span> <span class="p">=</span> <span class="k">this</span><span class="p">.</span><span class="n">defaultBucket</span><span class="p">;</span>
    <span class="n">buckets</span><span class="p">.</span><span class="nf">put</span><span class="p">(</span><span class="n">clientIP</span><span class="p">,</span> <span class="n">bucketByClientIP</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="nc">ConsumptionProbe</span> <span class="n">probe</span> <span class="p">=</span> <span class="n">bucketByClientIP</span><span class="p">.</span><span class="nf">tryConsumeAndReturnRemaining</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">tokensToConsumeByDefault</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">probe</span><span class="p">.</span><span class="nf">isConsumed</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">response</span><span class="p">.</span><span class="nf">addHeader</span><span class="p">(</span><span class="s">"X-Rate-Limit-Remaining"</span><span class="p">,</span>
      <span class="nc">Long</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="n">probe</span><span class="p">.</span><span class="nf">getRemainingTokens</span><span class="p">()));</span>
    <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
  <span class="p">}</span>

  <span class="n">response</span><span class="p">.</span><span class="nf">setStatus</span><span class="p">(</span><span class="nc">HttpStatus</span><span class="p">.</span><span class="nc">TOO_MANY_REQUESTS</span><span class="p">.</span><span class="nf">value</span><span class="p">());</span> <span class="c1">// 429</span>
  <span class="n">response</span><span class="p">.</span><span class="nf">addHeader</span><span class="p">(</span><span class="s">"X-Rate-Limit-Retry-After-Milliseconds"</span><span class="p">,</span>
    <span class="nc">Long</span><span class="p">.</span><span class="nf">toString</span><span class="p">(</span><span class="nc">TimeUnit</span><span class="p">.</span><span class="nc">NANOSECONDS</span><span class="p">.</span><span class="nf">toMillis</span><span class="p">(</span><span class="n">probe</span><span class="p">.</span><span class="nf">getNanosToWaitForRefill</span><span class="p">())));</span>

  <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>The magic of this library is in the <em>isConsumed()</em> method. After asking the bucket to consume a token from the basket, we test whether the token was consumed. If true, the limit was not exceeded, and the API allows the client to consume the endpoint. Otherwise, the limit was exceeded, and we rejected the request, returning an HTTP error code of 429 to the client.</p>

<div><script async="" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042" crossorigin="anonymous"></script>
<ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-9154513114335042" data-ad-slot="6734634393"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
<br /></div>

<p>We need to register our <em>RateLimitInterceptor</em> class by extending the <em>WebMvcConfigurerAdapter</em> class.</p>

<div class="language-kotlin highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre></td><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="k">public</span> <span class="kd">class</span> <span class="nc">InterceptorConfig</span> <span class="n">extends</span> <span class="nc">WebMvcConfigurerAdapter</span> <span class="p">{</span>

  <span class="nd">@Autowired</span>
  <span class="nc">RateLimitInterceptor</span> <span class="n">rateLimitInterceptor</span><span class="p">;</span>

  <span class="nd">@Override</span>
  <span class="k">public</span> <span class="n">void</span> <span class="nf">addInterceptors</span><span class="p">(</span><span class="nc">InterceptorRegistry</span> <span class="n">registry</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">registry</span><span class="p">.</span><span class="nf">addInterceptor</span><span class="p">(</span><span class="n">rateLimitInterceptor</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>After you send ten requests, the eleventh request is rejected, and the web client must wait for around 7 seconds, as shown in the following example.</p>

<p><img src="/assets/images/randomQuotePostmanRateLimit.jpg" alt="rate-Limit-random" class="img-responsive" /></p>

<p>Offering valuable content through your API can also motivate external developers or companies to pay more for leveraging the API. When they exceed the ten requests by default, they subscribe to plans.</p>

<p>Depending on how your software infrastructure is built, you can define plans with access to all API endpoints or a clientId+endpoint combination for example.</p>

<p>You can use these ideas when trying to implement rate limiting with Redis or with AWS.</p>

<p>You can download the code from the following link</p>

<p><a href="https://github.com/mgamio/rateLimit.git" target="_blank">Rate limit</a></p>

<p>In my next post, we will build an automated web client with random data to test the rate limit algorithm. Follow me!</p>

<div><!--<div class="alertbar">-->
	<div class="container text-center">
		<span><a class="navbar-brand" href="/"><img src="/assets/images/logo.svg" height="30" alt="codersite" /></a> &nbsp; Stay Connected!. Follow me to get my latest articles.</span>
        <form action="https://dev.us20.list-manage.com/subscribe/post?u=7ae24fed31c489e82aab00e64&amp;id=8d64d36cba" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate="">
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required="" />
            <input type="submit" value="Subscribe" name="subscribe" class="heart" />
            </div>
        </form>
	</div>
<!--</div>--></div>

				<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9154513114335042"
     crossorigin="anonymous"></script>
<!-- ad below post -->
<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-9154513114335042"
     data-ad-slot="2720551629"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
            </div>

            <!-- Rating -->
            

            <!-- Post Date -->
            <p>
            <small>
                <span class="post-date"><time class="post-date" datetime="2023-02-02">02 Feb 2023</time></span>           
                
                </small>
            </p>

            <!-- Post Categories -->
            <div class="after-post-cats">
                <ul class="tags mb-4">
                    
                    
                    <li>
                        <a class="smoothscroll" href="/categories#algorithms">algorithms</a>
                    </li>
                    
                </ul>
            </div>
            <!-- End Categories -->

            <!-- Post Tags -->
            <div class="after-post-tags">
                <ul class="tags">
                    
                    
                </ul>
            </div>
            <!-- End Tags -->

            <!-- Prev/Next -->
            <div class="row PageNavigation d-flex justify-content-between font-weight-bold">
            
            <a class="prev d-block col-md-6" href="http://localhost:4000/post-random-tweet-on-twitter-api/"> &laquo; How to Post a Random Tweet using Twitter API</a>
            
            
            <div class="clearfix"></div>
            </div>
            <!-- End Categories -->

        </div>
        <!-- End Post -->

    </div>
</div>
<!-- End Article
================================================== -->

<!-- Begin Comments
================================================== -->

<!--End Comments
================================================== -->

<!-- Review with LD-JSON, adapt it for your needs if you like, but make sure you test the generated HTML source code first: 
https://search.google.com/structured-data/testing-tool/u/0/
================================================== -->

</div>


<!-- Bottom Alert Bar
================================================== -->
<!--<div class="alertbar">-->
	<div class="container text-center">
		<span><a class="navbar-brand" href="/"><img src="/assets/images/logo.svg" height="30" alt="codersite"></a> &nbsp; Stay Connected!. Follow me to get my latest articles.</span>
        <form action="https://dev.us20.list-manage.com/subscribe/post?u=7ae24fed31c489e82aab00e64&amp;id=8d64d36cba" method="post" name="mc-embedded-subscribe-form" class="wj-contact-form validate" target="_blank" novalidate>
            <div class="mc-field-group">
            <input type="email" placeholder="Email" name="EMAIL" class="required email" id="mce-EMAIL" autocomplete="on" required>
            <input type="submit" value="Subscribe" name="subscribe" class="heart">
            </div>
        </form>
	</div>
<!--</div>-->

    
</div>

<!-- Categories Jumbotron
================================================== -->
<div class="jumbotron fortags">
	<div class="d-md-flex h-100">
		<div class="col-md-4 transpdark align-self-center text-center h-100">
            <div class="d-md-flex align-items-center justify-content-center h-100">
                <h2 class="d-md-block align-self-center py-1 font-weight-light">Explore <span class="d-none d-md-inline">â†’</span></h2>
            </div>
		</div>
		<div class="col-md-8 p-5 align-self-center text-center">
            
            
                
                    <a class="mt-1 mb-1" href="/categories#algorithms">algorithms (9)</a>
                
                    <a class="mt-1 mb-1" href="/categories#test-driven-development">test-driven development (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#design">design (3)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Web-APIs">Web APIs (4)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Coding-Practices">Coding Practices (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#distribuited-systems">distribuited systems (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Object-Oriented">Object-Oriented (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Domain-Driven-Design">Domain-Driven Design (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Language">Language (1)</a>
                
                    <a class="mt-1 mb-1" href="/categories#Web-Performance">Web Performance (1)</a>
                
            
            
		</div>
	</div>
</div>

<!-- Begin Footer
================================================== -->
<footer class="footer">
    <div class="container">
        <div class="row">
            <div class="col-md-6 col-sm-6 text-center text-lg-left">
                Copyright Â© 2023 codersite 
            </div>
            <div class="col-md-6 col-sm-6 text-center text-lg-right">    
                <a href="/policy">Privacy policy |</a>
				<a href="/termsOfService">Terms of service |</a>
				<a href="/impressum">Impressum</a>
            </div>
        </div>
    </div>
</footer>
<!-- End Footer
================================================== -->

</div> <!-- /.site-content -->

<!-- Scripts
================================================== -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut" crossorigin="anonymous"></script>

<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k" crossorigin="anonymous"></script>

<script src="/assets/js/mediumish.js"></script>



<script src="/assets/js/ie10-viewport-bug-workaround.js"></script> 


<script id="dsq-count-scr" src="//demowebsite.disqus.com/count.js"></script>


</body>
</html>
